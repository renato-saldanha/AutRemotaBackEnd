"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _querycompiler = _interopRequireDefault(require("knex/lib/query/querycompiler"));

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var QueryCompiler_Firebird = /*#__PURE__*/function (_QueryCompiler) {
  (0, _inherits2["default"])(QueryCompiler_Firebird, _QueryCompiler);

  var _super = _createSuper(QueryCompiler_Firebird);

  function QueryCompiler_Firebird() {
    (0, _classCallCheck2["default"])(this, QueryCompiler_Firebird);
    return _super.apply(this, arguments);
  }

  (0, _createClass2["default"])(QueryCompiler_Firebird, [{
    key: "columns",
    value: function columns() {
      var distinctClause = "";

      if (this.onlyUnions()) {
        return "";
      }

      var hints = this._hintComments();

      var columns = this.grouped.columns || [];
      var i = -1,
          sql = [];

      if (columns) {
        while (++i < columns.length) {
          var stmt = columns[i];
          if (stmt.distinct) distinctClause = "distinct ";

          if (stmt.distinctOn) {
            distinctClause = this.distinctOn(stmt.value);
            continue;
          }

          if (stmt.type === "aggregate") {
            var _sql;

            (_sql = sql).push.apply(_sql, (0, _toConsumableArray2["default"])(this.aggregate(stmt)));
          } else if (stmt.type === "aggregateRaw") {
            sql.push(this.aggregateRaw(stmt));
          } else if (stmt.type === "analytic") {
            sql.push(this.analytic(stmt));
          } else if (stmt.value && stmt.value.length > 0) {
            sql.push(this.formatter.columnize(stmt.value));
          }
        }
      }

      if (sql.length === 0) sql = ["*"];
      return "select ".concat(this._limit(), " ").concat(this._offset(), " ").concat(hints).concat(distinctClause) + sql.join(", ") + (this.tableName ? " from ".concat(this.single.only ? "only " : "").concat(this.tableName) : "");
    }
  }, {
    key: "_limit",
    value: function _limit() {
      return (0, _get2["default"])((0, _getPrototypeOf2["default"])(QueryCompiler_Firebird.prototype), "limit", this).call(this).replace("limit", "first");
    }
  }, {
    key: "_offset",
    value: function _offset() {
      return (0, _get2["default"])((0, _getPrototypeOf2["default"])(QueryCompiler_Firebird.prototype), "offset", this).call(this).replace("offset", "skip");
    }
  }, {
    key: "offset",
    value: function offset() {
      return "";
    }
  }, {
    key: "limit",
    value: function limit() {
      return "";
    }
  }, {
    key: "insert",
    value: function insert() {
      var sql = (0, _get2["default"])((0, _getPrototypeOf2["default"])(QueryCompiler_Firebird.prototype), "insert", this).call(this);
      if (sql === "") return sql;
      var returning = this.single.returning;
      if (returning) sql += this._returning(returning);
      return {
        sql: sql,
        returning: returning
      };
    }
  }, {
    key: "_returning",
    value: function _returning(value) {
      return value ? " returning ".concat(this.formatter.columnize(value)) : "";
    }
  }, {
    key: "_prepInsert",
    value: function _prepInsert(insertValues) {
      var newValues = {};

      for (var key in insertValues) {
        if (insertValues.hasOwnProperty(key)) {
          var value = insertValues[key];

          if (typeof value !== "undefined") {
            newValues[key] = value;
          }
        }
      }

      return (0, _get2["default"])((0, _getPrototypeOf2["default"])(QueryCompiler_Firebird.prototype), "_prepInsert", this).call(this, newValues);
    } // Compiles a `columnInfo` query

  }, {
    key: "columnInfo",
    value: function columnInfo() {
      var column = this.single.columnInfo; // The user may have specified a custom wrapIdentifier function in the config. We
      // need to run the identifiers through that function, but not format them as
      // identifiers otherwise.

      var table = this.client.customWrapIdentifier(this.single.table, this.identity);
      return {
        sql: "\n      select \n        rlf.rdb$field_name as name,\n        fld.rdb$character_length as max_length,\n        typ.rdb$type_name as type,\n        rlf.rdb$null_flag as not_null\n      from rdb$relation_fields rlf\n      inner join rdb$fields fld on fld.rdb$field_name = rlf.rdb$field_source\n      inner join rdb$types typ on typ.rdb$type = fld.rdb$field_type\n      where rdb$relation_name = '".concat(table, "'\n      "),
        output: function output(resp) {
          var _resp = (0, _slicedToArray2["default"])(resp, 2),
              rows = _resp[0],
              fields = _resp[1];

          var maxLengthRegex = /.*\((\d+)\)/;
          var out = reduce(rows, function (columns, val) {
            var name = val.NAME.trim();
            columns[name] = {
              type: val.TYPE.trim().toLowerCase(),
              nullable: !val.NOT_NULL // ATSTODO: "defaultValue" n√£o implementado
              // defaultValue: null,

            };

            if (val.MAX_LENGTH) {
              columns[name] = val.MAX_LENGTH;
            }

            return columns;
          }, {});
          return column && out[column] || out;
        }
      };
    }
  }, {
    key: "whereIn",
    value: function whereIn(statement) {
      var _this = this;

      if (Array.isArray(statement.column)) {
        var conditions = statement.value.map(function (valueCols) {
          return valueCols.map(function (value, idx) {
            return "".concat(_this.formatter.columnize(statement.column[idx]), " = ").concat(_this.formatter.values(value));
          }).join(" and ");
        });
        return "( ".concat(conditions.join("\n or "), " )");
      }

      return (0, _get2["default"])((0, _getPrototypeOf2["default"])(QueryCompiler_Firebird.prototype), "whereIn", this).call(this, statement);
    }
  }]);
  return QueryCompiler_Firebird;
}(_querycompiler["default"]);

var _default = QueryCompiler_Firebird;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyeS9jb21waWxlci5qcyJdLCJuYW1lcyI6WyJRdWVyeUNvbXBpbGVyX0ZpcmViaXJkIiwiZGlzdGluY3RDbGF1c2UiLCJvbmx5VW5pb25zIiwiaGludHMiLCJfaGludENvbW1lbnRzIiwiY29sdW1ucyIsImdyb3VwZWQiLCJpIiwic3FsIiwibGVuZ3RoIiwic3RtdCIsImRpc3RpbmN0IiwiZGlzdGluY3RPbiIsInZhbHVlIiwidHlwZSIsInB1c2giLCJhZ2dyZWdhdGUiLCJhZ2dyZWdhdGVSYXciLCJhbmFseXRpYyIsImZvcm1hdHRlciIsImNvbHVtbml6ZSIsIl9saW1pdCIsIl9vZmZzZXQiLCJqb2luIiwidGFibGVOYW1lIiwic2luZ2xlIiwib25seSIsInJlcGxhY2UiLCJyZXR1cm5pbmciLCJfcmV0dXJuaW5nIiwiaW5zZXJ0VmFsdWVzIiwibmV3VmFsdWVzIiwia2V5IiwiaGFzT3duUHJvcGVydHkiLCJjb2x1bW4iLCJjb2x1bW5JbmZvIiwidGFibGUiLCJjbGllbnQiLCJjdXN0b21XcmFwSWRlbnRpZmllciIsImlkZW50aXR5Iiwib3V0cHV0IiwicmVzcCIsInJvd3MiLCJmaWVsZHMiLCJtYXhMZW5ndGhSZWdleCIsIm91dCIsInJlZHVjZSIsInZhbCIsIm5hbWUiLCJOQU1FIiwidHJpbSIsIlRZUEUiLCJ0b0xvd2VyQ2FzZSIsIm51bGxhYmxlIiwiTk9UX05VTEwiLCJNQVhfTEVOR1RIIiwic3RhdGVtZW50IiwiQXJyYXkiLCJpc0FycmF5IiwiY29uZGl0aW9ucyIsIm1hcCIsInZhbHVlQ29scyIsImlkeCIsInZhbHVlcyIsIlF1ZXJ5Q29tcGlsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDQTs7Ozs7O0lBRU1BLHNCOzs7Ozs7Ozs7Ozs7V0FDSixtQkFBVTtBQUNSLFVBQUlDLGNBQWMsR0FBRyxFQUFyQjs7QUFDQSxVQUFJLEtBQUtDLFVBQUwsRUFBSixFQUF1QjtBQUNyQixlQUFPLEVB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LyBGaXJlYmlyZCBRdWVyeSBCdWlsZGVyICYgQ29tcGlsZXJcbmltcG9ydCBRdWVyeUNvbXBpbGVyIGZyb20gXCJrbmV4L2xpYi9xdWVyeS9xdWVyeWNvbXBpbGVyXCI7XG5cbmNsYXNzIFF1ZXJ5Q29tcGlsZXJfRmlyZWJpcmQgZXh0ZW5kcyBRdWVyeUNvbXBpbGVyIHtcbiAgY29sdW1ucygpIHtcbiAgICBsZXQgZGlzdGluY3RDbGF1c2UgPSBcIlwiO1xuICAgIGlmICh0aGlzLm9ubHlVbmlvbnMoKSkge1xuICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuXG4gICAgY29uc3QgaGludHMgPSB0aGlzLl9oaW50Q29tbWVudHMoKTtcbiAgICBjb25zdCBjb2x1bW5zID0gdGhpcy5ncm91cGVkLmNvbHVtbnMgfHwgW107XG4gICAgbGV0IGkgPSAtMSxcbiAgICAgIHNxbCA9IFtdO1xuXG4gICAgaWYgKGNvbHVtbnMpIHtcbiAgICAgIHdoaWxlICgrK2kgPCBjb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBzdG10ID0gY29sdW1uc1tpXTtcbiAgICAgICAgaWYgKHN0bXQuZGlzdGluY3QpIGRpc3RpbmN0Q2xhdXNlID0gXCJkaXN0aW5jdCBcIjtcbiAgICAgICAgaWYgKHN0bXQuZGlzdGluY3RPbikge1xuICAgICAgICAgIGRpc3RpbmN0Q2xhdXNlID0gdGhpcy5kaXN0aW5jdE9uKHN0bXQudmFsdWUpO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdG10LnR5cGUgPT09IFwiYWdncmVnYXRlXCIpIHtcbiAgICAgICAgICBzcWwucHVzaCguLi50aGlzLmFnZ3JlZ2F0ZShzdG10KSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RtdC50eXBlID09PSBcImFnZ3JlZ2F0ZVJhd1wiKSB7XG4gICAgICAgICAgc3FsLnB1c2godGhpcy5hZ2dyZWdhdGVSYXcoc3RtdCkpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0bXQudHlwZSA9PT0gXCJhbmFseXRpY1wiKSB7XG4gICAgICAgICAgc3FsLnB1c2godGhpcy5hbmFseXRpYyhzdG10KSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RtdC52YWx1ZSAmJiBzdG10LnZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBzcWwucHVzaCh0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoc3RtdC52YWx1ZSkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzcWwubGVuZ3RoID09PSAwKSBzcWwgPSBbXCIqXCJdO1xuICAgIHJldHVybiAoXG4gICAgICBgc2VsZWN0ICR7dGhpcy5fbGltaXQoKX0gJHt0aGlzLl9vZmZzZXQoKX0gJHtoaW50c30ke2Rpc3RpbmN0Q2xhdXNlfWAgK1xuICAgICAgc3FsLmpvaW4oXCIsIFwiKSArXG4gICAgICAodGhpcy50YWJsZU5hbWVcbiAgICAgICAgPyBgIGZyb20gJHt0aGlzLnNpbmdsZS5vbmx5ID8gXCJvbmx5IFwiIDogXCJcIn0ke3RoaXMudGFibGVOYW1lfWBcbiAgICAgICAgOiBcIlwiKVxuICAgICk7XG4gIH1cblxuICBfbGltaXQoKSB7XG4gICAgcmV0dXJuIHN1cGVyLmxpbWl0KCkucmVwbGFjZShcImxpbWl0XCIsIFwiZmlyc3RcIik7XG4gIH1cblxuICBfb2Zmc2V0KCkge1xuICAgIHJldHVybiBzdXBlci5vZmZzZXQoKS5yZXBsYWNlKFwib2Zmc2V0XCIsIFwic2tpcFwiKTtcbiAgfVxuXG4gIG9mZnNldCgpIHtcbiAgICByZXR1cm4gXCJcIjtcbiAgfVxuXG4gIGxpbWl0KCkge1xuICAgIHJldHVybiBcIlwiO1xuICB9XG5cbiAgaW5zZXJ0KCkge1xuICAgIGxldCBzcWwgPSBzdXBlci5pbnNlcnQoKTtcbiAgICBpZiAoc3FsID09PSBcIlwiKSByZXR1cm4gc3FsO1xuXG4gICAgY29uc3QgeyByZXR1cm5pbmcgfSA9IHRoaXMuc2luZ2xlO1xuICAgIGlmIChyZXR1cm5pbmcpIHNxbCArPSB0aGlzLl9yZXR1cm5pbmcocmV0dXJuaW5nKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzcWw6IHNxbCxcbiAgICAgIHJldHVybmluZyxcbiAgICB9O1xuICB9XG5cbiAgX3JldHVybmluZyh2YWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZSA/IGAgcmV0dXJuaW5nICR7dGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKHZhbHVlKX1gIDogXCJcIjtcbiAgfVxuXG4gIF9wcmVwSW5zZXJ0KGluc2VydFZhbHVlcykge1xuICAgIGNvbnN0IG5ld1ZhbHVlcyA9IHt9O1xuICAgIGZvciAoY29uc3Qga2V5IGluIGluc2VydFZhbHVlcykge1xuICAgICAgaWYgKGluc2VydFZhbHVlcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gaW5zZXJ0VmFsdWVzW2tleV07XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgICAgICBuZXdWYWx1ZXNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBzdXBlci5fcHJlcEluc2VydChuZXdWYWx1ZXMpO1xuICB9XG4gIC8vIENvbXBpbGVzIGEgYGNvbHVtbkluZm9gIHF1ZXJ5XG4gIGNvbHVtbkluZm8oKSB7XG4gICAgY29uc3QgY29sdW1uID0gdGhpcy5zaW5nbGUuY29sdW1uSW5mbztcblxuICAgIC8vIFRoZSB1c2VyIG1heSBoYXZlIHNwZWNpZmllZCBhIGN1c3RvbSB3cmFwSWRlbnRpZmllciBmdW5jdGlvbiBpbiB0aGUgY29uZmlnLiBXZVxuICAgIC8vIG5lZWQgdG8gcnVuIHRoZSBpZGVudGlmaWVycyB0aHJvdWdoIHRoYXQgZnVuY3Rpb24sIGJ1dCBub3QgZm9ybWF0IHRoZW0gYXNcbiAgICAvLyBpZGVudGlmaWVycyBvdGhlcndpc2UuXG4gICAgY29uc3QgdGFibGUgPSB0aGlzLmNsaWVudC5jdXN0b21XcmFwSWRlbnRpZmllcihcbiAgICAgIHRoaXMuc2luZ2xlLnRhYmxlLFxuICAgICAgdGhpcy5pZGVudGl0eVxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3FsOiBgXG4gICAgICBzZWxlY3QgXG4gICAgICAgIHJsZi5yZGIkZmllbGRfbmFtZSBhcyBuYW1lLFxuICAgICAgICBmbGQucmRiJGNoYXJhY3Rlcl9sZW5ndGggYXMgbWF4X2xlbmd0aCxcbiAgICAgICAgdHlwLnJkYiR0eXBlX25hbWUgYXMgdHlwZSxcbiAgICAgICAgcmxmLnJkYiRudWxsX2ZsYWcgYXMgbm90X251bGxcbiAgICAgIGZyb20gcmRiJHJlbGF0aW9uX2ZpZWxkcyBybGZcbiAgICAgIGlubmVyIGpvaW4gcmRiJGZpZWxkcyBmbGQgb24gZmxkLnJkYiRmaWVsZF9uYW1lID0gcmxmLnJkYiRmaWVsZF9zb3VyY2VcbiAgICAgIGlubmVyIGpvaW4gcmRiJHR5cGVzIHR5cCBvbiB0eXAucmRiJHR5cGUgPSBmbGQucmRiJGZpZWxkX3R5cGVcbiAgICAgIHdoZXJlIHJkYiRyZWxhdGlvbl9uYW1lID0gJyR7dGFibGV9J1xuICAgICAgYCxcbiAgICAgIG91dHB1dChyZXNwKSB7XG4gICAgICAgIGNvbnN0IFtyb3dzLCBmaWVsZHNdID0gcmVzcDtcblxuICAgICAgICBjb25zdCBtYXhMZW5ndGhSZWdleCA9IC8uKlxcKChcXGQrKVxcKS87XG4gICAgICAgIGNvbnN0IG91dCA9IHJlZHVjZShcbiAgICAgICAgICByb3dzLFxuICAgICAgICAgIGZ1bmN0aW9uIChjb2x1bW5zLCB2YWwpIHtcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSB2YWwuTkFNRS50cmltKCk7XG4gICAgICAgICAgICBjb2x1bW5zW25hbWVdID0ge1xuICAgICAgICAgICAgICB0eXBlOiB2YWwuVFlQRS50cmltKCkudG9Mb3dlckNhc2UoKSxcbiAgICAgICAgICAgICAgbnVsbGFibGU6ICF2YWwuTk9UX05VTEwsXG4gICAgICAgICAgICAgIC8vIEFUU1RPRE86IFwiZGVmYXVsdFZhbHVlXCIgbsOjbyBpbXBsZW1lbnRhZG9cbiAgICAgICAgICAgICAgLy8gZGVmYXVsdFZhbHVlOiBudWxsLFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgaWYgKHZhbC5NQVhfTEVOR1RIKSB7XG4gICAgICAgICAgICAgIGNvbHVtbnNbbmFtZV0gPSB2YWwuTUFYX0xFTkdUSDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGNvbHVtbnM7XG4gICAgICAgICAgfSxcbiAgICAgICAgICB7fVxuICAgICAgICApO1xuICAgICAgICByZXR1cm4gKGNvbHVtbiAmJiBvdXRbY29sdW1uXSkgfHwgb3V0O1xuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgd2hlcmVJbihzdGF0ZW1lbnQpIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShzdGF0ZW1lbnQuY29sdW1uKSkge1xuICAgICAgY29uc3QgY29uZGl0aW9ucyA9IHN0YXRlbWVudC52YWx1ZS5tYXAoKHZhbHVlQ29scykgPT5cbiAgICAgICAgdmFsdWVDb2xzXG4gICAgICAgICAgLm1hcCgodmFsdWUsIGlkeCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGAke3RoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShcbiAgICAgICAgICAgICAgc3RhdGVtZW50LmNvbHVtbltpZHhdXG4gICAgICAgICAgICApfSA9ICR7dGhpcy5mb3JtYXR0ZXIudmFsdWVzKHZhbHVlKX1gO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLmpvaW4oXCIgYW5kIFwiKVxuICAgICAgKTtcbiAgICAgIHJldHVybiBgKCAke2NvbmRpdGlvbnMuam9pbihcIlxcbiBvciBcIil9IClgO1xuICAgIH1cbiAgICByZXR1cm4gc3VwZXIud2hlcmVJbihzdGF0ZW1lbnQpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFF1ZXJ5Q29tcGlsZXJfRmlyZWJpcmQ7XG4iXX0=