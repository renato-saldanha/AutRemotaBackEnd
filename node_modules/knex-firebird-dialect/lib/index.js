"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _construct2 = _interopRequireDefault(require("@babel/runtime/helpers/construct"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _get2 = _interopRequireDefault(require("@babel/runtime/helpers/get"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _lodash = require("lodash");

var _getStream = _interopRequireDefault(require("get-stream"));

var _assert = _interopRequireDefault(require("assert"));

var _client = _interopRequireDefault(require("knex/lib/client"));

var _columncompiler = _interopRequireDefault(require("./schema/columncompiler"));

var _compiler = _interopRequireDefault(require("./query/compiler"));

var _tablecompiler = _interopRequireDefault(require("./schema/tablecompiler"));

var _transaction = _interopRequireDefault(require("./transaction"));

var _compiler2 = _interopRequireDefault(require("./schema/compiler"));

var _formatter = _interopRequireDefault(require("./formatter"));

var _ddl = _interopRequireDefault(require("./schema/ddl"));

var _utils = require("./utils");

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2["default"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2["default"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2["default"])(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var Client_Firebird = /*#__PURE__*/function (_Client) {
  (0, _inherits2["default"])(Client_Firebird, _Client);

  var _super = _createSuper(Client_Firebird);

  function Client_Firebird() {
    (0, _classCallCheck2["default"])(this, Client_Firebird);
    return _super.apply(this, arguments);
  }

  (0, _createClass2["default"])(Client_Firebird, [{
    key: "_driver",
    value: function _driver() {
      return require("node-firebird");
    }
  }, {
    key: "schemaCompiler",
    value: function schemaCompiler() {
      return (0, _construct2["default"])(_compiler2["default"], [this].concat(Array.prototype.slice.call(arguments)));
    }
  }, {
    key: "queryCompiler",
    value: function queryCompiler(builder, formatter) {
      return new _compiler["default"](this, builder, formatter);
    }
  }, {
    key: "columnCompiler",
    value: function columnCompiler() {
      return (0, _construct2["default"])(_columncompiler["default"], [this].concat(Array.prototype.slice.call(arguments)));
    }
  }, {
    key: "tableCompiler",
    value: function tableCompiler() {
      return (0, _construct2["default"])(_tablecompiler["default"], [this].concat(Array.prototype.slice.call(arguments)));
    }
  }, {
    key: "transaction",
    value: function transaction() {
      return (0, _construct2["default"])(_transaction["default"], [this].concat(Array.prototype.slice.call(arguments)));
    }
  }, {
    key: "wrapIdentifierImpl",
    value: function wrapIdentifierImpl(value) {
      if (value === "*") {
        return value;
      }

      return value;
    } // Get a raw connection from the database, returning a promise with the connection object.

  }, {
    key: "acquireRawConnection",
    value: function acquireRawConnection() {
      var _this = this;

      (0, _assert["default"])(!this._connectionForTransactions);
      var driverConnectFn = this.config.createDatabaseIfNotExists ? this.driver.attachOrCreate : this.driver.attach;
      return new Promise(function (resolve, reject) {
        driverConnectFn(_this.connectionSettings, function (error, connection) {
          if (error) {
            return reject(error);
          }

          resolve(connection);
        });
      });
    } // Used to explicitly close a connection, called internally by the pool when
    // a connection times out or the pool is shutdown.

  }, {
    key: "destroyRawConnection",
    value: function () {
      var _destroyRawConnection = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee(connection) {
        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                return _context.abrupt("return", new Promise(function (resolve, reject) {
                  connection.connection._socket.once("close", function () {
                    resolve();
                  });

                  connection.detach(function (err) {
                    if (err) {
                      reject(err);
                    }

                    connection.connection._socket.destroy();
                  });
                }));

              case 1:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }));

      function destroyRawConnection(_x) {
        return _destroyRawConnection.apply(this, arguments);
      }

      return destroyRawConnection;
    }() // Runs the query on the specified connection, providing the bindings and any
    // other necessary prep work.

  }, {
    key: "_query",
    value: function _query(connection, obj) {
      if (!obj || typeof obj === "string") {
        obj = {
          sql: obj
        };
      }

      return new Promise(function (resolver, rejecter) {
        if (!connection) {
          return rejecter(new Error("Error calling ".concat(obj.method, " on connection.")));
        }

        var _obj = obj,
            sql = _obj.sql;

        if (!sql) {
          return resolver();
        }

        var c = connection._trasaction || connection;
        c.query(sql, obj.bindings, function (error, rows, fields) {
          if (error) {
            return rejecter(error);
          }

          obj.response = [rows, fields];
          resolver(obj);
        });
      });
    }
  }, {
    key: "_stream",
    value: function _stream() {
      throw new Error("_stream not implemented"); // const client = this;
      // return new Promise(function (resolver, rejecter) {
      //   stream.on('error', rejecter);
      //   stream.on('end', resolver);
      //   return client
      //     ._query(connection, sql)
      //     .then((obj) => obj.response)
      //     .then((rows) => rows.forEach((row) => stream.write(row)))
      //     .catch(function (err) {
      //       stream.emit('error', err);
      //     })
      //     .then(function () {
      //       stream.end();
      //     });
      // });
    } // Ensures the response is returned in the same format as other clients.

  }, {
    key: "processResponse",
    value: function () {
      var _processResponse = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee2(obj, runner) {
        var response, method, _response, rows, fields;

        return _regenerator["default"].wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                if (obj) {
                  _context2.next = 2;
                  break;
                }

                return _context2.abrupt("return");

              case 2:
                response = obj.response, method = obj.method;

                if (!obj.output) {
                  _context2.next = 5;
                  break;
                }

                return _context2.abrupt("return", obj.output.call(runner, response));

              case 5:
                _response = (0, _slicedToArray2["default"])(response, 2), rows = _response[0], fields = _response[1];
                _context2.next = 8;
                return this._fixBlobCallbacks(rows, fields);

              case 8:
                _context2.t0 = method;
                _context2.next = _context2.t0 === "first" ? 11 : _context2.t0 === "pluck" ? 12 : 13;
                break;

              case 11:
                return _context2.abrupt("return", rows[0]);

              case 12:
                return _context2.abrupt("return", (0, _lodash.map)(rows, obj.pluck));

              case 13:
                return _context2.abrupt("return", rows);

              case 14:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function processResponse(_x2, _x3) {
        return _processResponse.apply(this, arguments);
      }

      return processResponse;
    }()
    /**
     * The Firebird library returns BLOBs with callback function, convert to buffer
     * @param {*} rows
     * @param {*} fields
     */

  }, {
    key: "_fixBlobCallbacks",
    value: function () {
      var _fixBlobCallbacks2 = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee3(rows
      /* fields */
      ) {
        var blobEntries;
        return _regenerator["default"].wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                if (rows) {
                  _context3.next = 2;
                  break;
                }

                return _context3.abrupt("return", rows);

              case 2:
                blobEntries = [];
                (0, _utils.toArrayFromPrimitive)(rows).forEach(function (row, rowIndex) {
                  Object.entries(row).forEach(function (_ref) {
                    var _ref2 = (0, _slicedToArray2["default"])(_ref, 2),
                        colKey = _ref2[0],
                        colVal = _ref2[1];

                    if (colVal instanceof Function) {
                      blobEntries.push(new Promise(function (resolve) {
                        colVal(function (err, name, emitter) {
                          _getStream["default"].buffer(emitter).then(function (buffer) {
                            rows[rowIndex][colKey] = buffer;
                            resolve();
                          });
                        });
                      }));
                    } else if (colVal instanceof Buffer) {
                      rows[rowIndex][colKey] = colVal.toString("utf8");
                    }
                  });
                });
                _context3.next = 6;
                return Promise.all(blobEntries);

              case 6:
                return _context3.abrupt("return", rows);

              case 7:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3);
      }));

      function _fixBlobCallbacks(_x4) {
        return _fixBlobCallbacks2.apply(this, arguments);
      }

      return _fixBlobCallbacks;
    }()
  }, {
    key: "validateConnection",
    value: function validateConnection(db) {
      var _db$connection = db.connection,
          _isClosed = _db$connection._isClosed,
          _isDetach = _db$connection._isDetach,
          _socket = _db$connection._socket,
          _isOpened = _db$connection._isOpened;

      if (_isClosed || _isDetach || !_socket || !_isOpened) {
        return false;
      }

      return true;
    }
  }, {
    key: "poolDefaults",
    value: function poolDefaults() {
      var options = {
        min: 2,
        max: 4
      };
      return (0, _lodash.defaults)(options, (0, _get2["default"])((0, _getPrototypeOf2["default"])(Client_Firebird.prototype), "poolDefaults", this).call(this, this));
    }
  }, {
    key: "ping",
    value: function ping(resource, callback) {
      resource.query("select 1 from RDB$DATABASE", callback);
    }
  }, {
    key: "ddl",
    value: function ddl(compiler, pragma, connection) {
      return new _ddl["default"](this, compiler, pragma, connection);
    }
  }]);
  return Client_Firebird;
}(_client["default"]);

Object.assign(Client_Firebird.prototype, {
  dialect: "firebird",
  driverName: "node-firebird",
  Firebird_Formatter: _formatter["default"]
});
var _default = Client_Firebird;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJDbGllbnRfRmlyZWJpcmQiLCJyZXF1aXJlIiwiU2NoZW1hQ29tcGlsZXIiLCJhcmd1bWVudHMiLCJidWlsZGVyIiwiZm9ybWF0dGVyIiwiUXVlcnlDb21waWxlciIsIkNvbHVtbkNvbXBpbGVyIiwiVGFibGVDb21waWxlciIsIlRyYW5zYWN0aW9uIiwidmFsdWUiLCJfY29ubmVjdGlvbkZvclRyYW5zYWN0aW9ucyIsImRyaXZlckNvbm5lY3RGbiIsImNvbmZpZyIsImNyZWF0ZURhdGFiYXNlSWZOb3RFeGlzdHMiLCJkcml2ZXIiLCJhdHRhY2hPckNyZWF0ZSIsImF0dGFjaCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY29ubmVjdGlvblNldHRpbmdzIiwiZXJyb3IiLCJjb25uZWN0aW9uIiwiX3NvY2tldCIsIm9uY2UiLCJkZXRhY2giLCJlcnIiLCJkZXN0cm95Iiwib2JqIiwic3FsIiwicmVzb2x2ZXIiLCJyZWplY3RlciIsIkVycm9yIiwibWV0aG9kIiwiYyIsIl90cmFzYWN0aW9uIiwicXVlcnkiLCJiaW5kaW5ncyIsInJvd3MiLCJmaWVsZHMiLCJyZXNwb25zZSIsInJ1bm5lciIsIm91dHB1dCIsImNhbGwiLCJfZml4QmxvYkNhbGxiYWNrcyIsInBsdWNrIiwiYmxvYkVudHJpZXMiLCJmb3JFYWNoIiwicm93Iiwicm93SW5kZXgiLCJPYmplY3QiLCJlbnRyaWVzIiwiY29sS2V5IiwiY29sVmFsIiwiRnVuY3Rpb24iLCJwdXNoIiwibmFtZSIsImVtaXR0ZXIiLCJnZXRTdHJlYW0iLCJidWZmZXIiLCJ0aGVuIiwiQnVmZmVyIiwidG9TdHJpbmciLCJhbGwiLCJkYiIsIl9pc0Nsb3NlZCIsIl9pc0RldGFjaCIsIl9pc09wZW5lZCIsIm9wdGlvbnMiLCJtaW4iLCJtYXgiLCJyZXNvdXJjZSIsImNhbGxiYWNrIiwiY29tcGlsZXIiLCJwcmFnbWEiLCJGaXJlYmlyZF9EREwiLCJDbGllbnQiLCJhc3NpZ24iLCJwcm90b3R5cGUiLCJkaWFsZWN0IiwiZHJpdmVyTmFtZSIsIkZpcmViaXJkX0Zvcm1hdHRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0lBRU1BLGU7Ozs7Ozs7Ozs7OztXQUNKLG1CQUFVO0FBQ1IsYUFBT0MsT0FBTyxDQUFDLGVBQUQsQ0FBZDtBQUNEOzs7V0FFRCwwQkFBaUI7QUFDZix5Q0FBV0MscUJBQVgsR0FBMEIsSUFBMUIsb0NBQW1DQyxTQUFuQztBQUNEOzs7V0FFRCx1QkFBY0MsT0FBZCxFQUF1QkMsU0FBdkIsRUFBa0M7QUFDaEMsYUFBTyxJQUFJQyxvQkFBSixDQUFrQixJQUFsQixFQUF3QkYsT0FBeEIsRUFBaUNDLFNBQWpDLENBQVA7QUFDRDs7O1dBRUQsMEJBQWlCO0FBQ2YseUNBQVdFLDBCQUFYLEdBQTBCLElBQTFCLG9DQUFtQ0osU0FBbkM7QUFDRDs7O1dBRUQseUJBQWdCO0FBQ2QseUNBQVdLLHlCQUFYLEdBQXlCLElBQXpCLG9DQUFrQ0wsU0FBbEM7QUFDRDs7O1dBRUQsdUJBQWM7QUFDWix5Q0FBV00sdUJBQVgsR0FBdUIsSUFBdkIsb0NBQWdDTixTQUFoQztBQUNEOzs7V0FFRCw0QkFBbUJPLEtBQW5CLEVBQTBCO0FBQ3hCLFVBQUlBLEtBQUssS0FBSyxHQUFkLEVBQW1CO0FBQ2pCLGVBQU9BLEtBQVA7QUFDRDs7QUFFRCxhQUFPQSxLQUFQO0FBQ0QsSyxDQUVEOzs7O1dBQ0EsZ0NBQXVCO0FBQUE7O0FBQ3JCLDhCQUFPLENBQUMsS0FBS0MsMEJBQWI7QUFFQSxVQUFNQyxlQUFlLEdBQUcsS0FBS0MsTUFBTCxDQUFZQyx5QkFBWixHQUNwQixLQUFLQyxNQUFMLENBQVlDLGNBRFEsR0FFcEIsS0FBS0QsTUFBTCxDQUFZRSxNQUZoQjtBQUlBLGFBQU8sSUFBSUMsT0FBSixDQUFZLFVBQUND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QUcsRUFBRTtBQUFmLE9BQWhCO0FBQ0EsYUFBTyxzQkFBU0YsT0FBVCxzSEFBcUMsSUFBckMsRUFBUDtBQUNEOzs7V0FFRCxjQUFLRyxRQUFMLEVBQWVDLFFBQWYsRUFBeUI7QUFDdkJELE1BQUFBLFFBQVEsQ0FBQ25DLEtBQVQsQ0FBZSw0QkFBZixFQUE2Q29DLFFBQTdDO0FBQ0Q7OztXQUVELGFBQUlDLFFBQUosRUFBY0MsTUFBZCxFQUFzQnBELFVBQXRCLEVBQWtDO0FBQ2hDLGFBQU8sSUFBSXFELGVBQUosQ0FBaUIsSUFBakIsRUFBdUJGLFFBQXZCLEVBQWlDQyxNQUFqQyxFQUF5Q3BELFVBQXpDLENBQVA7QUFDRDs7O0VBcE0yQnNELGtCOztBQXVNOUIxQixNQUFNLENBQUMyQixNQUFQLENBQWM5RSxlQUFlLENBQUMrRSxTQUE5QixFQUF5QztBQUN2Q0MsRUFBQUEsT0FBTyxFQUFFLFVBRDhCO0FBRXZDQyxFQUFBQSxVQUFVLEVBQUUsZUFGMkI7QUFJdkNDLEVBQUFBLGtCQUFrQixFQUFsQkE7QUFKdUMsQ0FBekM7ZUFPZWxGLGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZWZhdWx0cywgbWFwIH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IGdldFN0cmVhbSBmcm9tIFwiZ2V0LXN0cmVhbVwiO1xuXG5pbXBvcnQgYXNzZXJ0IGZyb20gXCJhc3NlcnRcIjtcbmltcG9ydCBDbGllbnQgZnJvbSBcImtuZXgvbGliL2NsaWVudFwiO1xuXG5pbXBvcnQgQ29sdW1uQ29tcGlsZXIgZnJvbSBcIi4vc2NoZW1hL2NvbHVtbmNvbXBpbGVyXCI7XG5pbXBvcnQgUXVlcnlDb21waWxlciBmcm9tIFwiLi9xdWVyeS9jb21waWxlclwiO1xuaW1wb3J0IFRhYmxlQ29tcGlsZXIgZnJvbSBcIi4vc2NoZW1hL3RhYmxlY29tcGlsZXJcIjtcbmltcG9ydCBUcmFuc2FjdGlvbiBmcm9tIFwiLi90cmFuc2FjdGlvblwiO1xuaW1wb3J0IFNjaGVtYUNvbXBpbGVyIGZyb20gXCIuL3NjaGVtYS9jb21waWxlclwiO1xuaW1wb3J0IEZpcmViaXJkX0Zvcm1hdHRlciBmcm9tIFwiLi9mb3JtYXR0ZXJcIjtcbmltcG9ydCBGaXJlYmlyZF9EREwgZnJvbSBcIi4vc2NoZW1hL2RkbFwiO1xuaW1wb3J0IHsgdG9BcnJheUZyb21QcmltaXRpdmUgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5jbGFzcyBDbGllbnRfRmlyZWJpcmQgZXh0ZW5kcyBDbGllbnQge1xuICBfZHJpdmVyKCkge1xuICAgIHJldHVybiByZXF1aXJlKFwibm9kZS1maXJlYmlyZFwiKTtcbiAgfVxuXG4gIHNjaGVtYUNvbXBpbGVyKCkge1xuICAgIHJldHVybiBuZXcgU2NoZW1hQ29tcGlsZXIodGhpcywgLi4uYXJndW1lbnRzKTtcbiAgfVxuXG4gIHF1ZXJ5Q29tcGlsZXIoYnVpbGRlciwgZm9ybWF0dGVyKSB7XG4gICAgcmV0dXJuIG5ldyBRdWVyeUNvbXBpbGVyKHRoaXMsIGJ1aWxkZXIsIGZvcm1hdHRlcik7XG4gIH1cblxuICBjb2x1bW5Db21waWxlcigpIHtcbiAgICByZXR1cm4gbmV3IENvbHVtbkNvbXBpbGVyKHRoaXMsIC4uLmFyZ3VtZW50cyk7XG4gIH1cblxuICB0YWJsZUNvbXBpbGVyKCkge1xuICAgIHJldHVybiBuZXcgVGFibGVDb21waWxlcih0aGlzLCAuLi5hcmd1bWVudHMpO1xuICB9XG5cbiAgdHJhbnNhY3Rpb24oKSB7XG4gICAgcmV0dXJuIG5ldyBUcmFuc2FjdGlvbih0aGlzLCAuLi5hcmd1bWVudHMpO1xuICB9XG5cbiAgd3JhcElkZW50aWZpZXJJbXBsKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlID09PSBcIipcIikge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIC8vIEdldCBhIHJhdyBjb25uZWN0aW9uIGZyb20gdGhlIGRhdGFiYXNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHdpdGggdGhlIGNvbm5lY3Rpb24gb2JqZWN0LlxuICBhY3F1aXJlUmF3Q29ubmVjdGlvbigpIHtcbiAgICBhc3NlcnQoIXRoaXMuX2Nvbm5lY3Rpb25Gb3JUcmFuc2FjdGlvbnMpO1xuXG4gICAgY29uc3QgZHJpdmVyQ29ubmVjdEZuID0gdGhpcy5jb25maWcuY3JlYXRlRGF0YWJhc2VJZk5vdEV4aXN0c1xuICAgICAgPyB0aGlzLmRyaXZlci5hdHRhY2hPckNyZWF0ZVxuICAgICAgOiB0aGlzLmRyaXZlci5hdHRhY2g7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZHJpdmVyQ29ubmVjdEZuKHRoaXMuY29ubmVjdGlvblNldHRpbmdzLCAoZXJyb3IsIGNvbm5lY3Rpb24pID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnJvcik7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZShjb25uZWN0aW9uKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2wgd2hlblxuICAvLyBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLlxuICBhc3luYyBkZXN0cm95UmF3Q29ubmVjdGlvbihjb25uZWN0aW9uKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5fc29ja2V0Lm9uY2UoXCJjbG9zZVwiLCAoKSA9PiB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25uZWN0aW9uLmRldGFjaCgoZXJyKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbm5lY3Rpb24uY29ubmVjdGlvbi5fc29ja2V0LmRlc3Ryb3koKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzIGFuZCBhbnlcbiAgLy8gb3RoZXIgbmVjZXNzYXJ5IHByZXAgd29yay5cbiAgX3F1ZXJ5KGNvbm5lY3Rpb24sIG9iaikge1xuICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIG9iaiA9IHsgc3FsOiBvYmogfTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlciwgcmVqZWN0ZXIpIHtcbiAgICAgIGlmICghY29ubmVjdGlvbikge1xuICAgICAgICByZXR1cm4gcmVqZWN0ZXIoXG4gICAgICAgICAgbmV3IEVycm9yKGBFcnJvciBjYWxsaW5nICR7b2JqLm1ldGhvZH0gb24gY29ubmVjdGlvbi5gKVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7IHNxbCB9ID0gb2JqO1xuICAgICAgaWYgKCFzcWwpIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmVyKCk7XG4gICAgICB9XG4gICAgICBjb25zdCBjID0gY29ubmVjdGlvbi5fdHJhc2FjdGlvbiB8fCBjb25uZWN0aW9uO1xuICAgICAgYy5xdWVyeShzcWwsIG9iai5iaW5kaW5ncywgKGVycm9yLCByb3dzLCBmaWVsZHMpID0+IHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdGVyKGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgICBvYmoucmVzcG9uc2UgPSBbcm93cywgZmllbGRzXTtcbiAgICAgICAgcmVzb2x2ZXIob2JqKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgX3N0cmVhbSgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJfc3RyZWFtIG5vdCBpbXBsZW1lbnRlZFwiKTtcbiAgICAvLyBjb25zdCBjbGllbnQgPSB0aGlzO1xuICAgIC8vIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZXIsIHJlamVjdGVyKSB7XG4gICAgLy8gICBzdHJlYW0ub24oJ2Vycm9yJywgcmVqZWN0ZXIpO1xuICAgIC8vICAgc3RyZWFtLm9uKCdlbmQnLCByZXNvbHZlcik7XG4gICAgLy8gICByZXR1cm4gY2xpZW50XG4gICAgLy8gICAgIC5fcXVlcnkoY29ubmVjdGlvbiwgc3FsKVxuICAgIC8vICAgICAudGhlbigob2JqKSA9PiBvYmoucmVzcG9uc2UpXG4gICAgLy8gICAgIC50aGVuKChyb3dzKSA9PiByb3dzLmZvckVhY2goKHJvdykgPT4gc3RyZWFtLndyaXRlKHJvdykpKVxuICAgIC8vICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgIC8vICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7XG4gICAgLy8gICAgIH0pXG4gICAgLy8gICAgIC50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAvLyAgICAgICBzdHJlYW0uZW5kKCk7XG4gICAgLy8gICAgIH0pO1xuICAgIC8vIH0pO1xuICB9XG5cbiAgLy8gRW5zdXJlcyB0aGUgcmVzcG9uc2UgaXMgcmV0dXJuZWQgaW4gdGhlIHNhbWUgZm9ybWF0IGFzIG90aGVyIGNsaWVudHMuXG4gIGFzeW5jIHByb2Nlc3NSZXNwb25zZShvYmosIHJ1bm5lcikge1xuICAgIGlmICghb2JqKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHsgcmVzcG9uc2UsIG1ldGhvZCB9ID0gb2JqO1xuICAgIGlmIChvYmoub3V0cHV0KSB7XG4gICAgICByZXR1cm4gb2JqLm91dHB1dC5jYWxsKHJ1bm5lciwgcmVzcG9uc2UpO1xuICAgIH1cblxuICAgIGNvbnN0IFtyb3dzLCBmaWVsZHNdID0gcmVzcG9uc2U7XG4gICAgYXdhaXQgdGhpcy5fZml4QmxvYkNhbGxiYWNrcyhyb3dzLCBmaWVsZHMpO1xuXG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgXCJmaXJzdFwiOlxuICAgICAgICByZXR1cm4gcm93c1swXTtcbiAgICAgIGNhc2UgXCJwbHVja1wiOlxuICAgICAgICByZXR1cm4gbWFwKHJvd3MsIG9iai5wbHVjayk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gcm93cztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhlIEZpcmViaXJkIGxpYnJhcnkgcmV0dXJucyBCTE9CcyB3aXRoIGNhbGxiYWNrIGZ1bmN0aW9uLCBjb252ZXJ0IHRvIGJ1ZmZlclxuICAgKiBAcGFyYW0geyp9IHJvd3NcbiAgICogQHBhcmFtIHsqfSBmaWVsZHNcbiAgICovXG4gIGFzeW5jIF9maXhCbG9iQ2FsbGJhY2tzKHJvd3MgLyogZmllbGRzICovKSB7XG4gICAgaWYgKCFyb3dzKSB7XG4gICAgICByZXR1cm4gcm93cztcbiAgICB9XG5cbiAgICBjb25zdCBibG9iRW50cmllcyA9IFtdO1xuXG4gICAgdG9BcnJheUZyb21QcmltaXRpdmUocm93cykuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgT2JqZWN0LmVudHJpZXMocm93KS5mb3JFYWNoKChbY29sS2V5LCBjb2xWYWxdKSA9PiB7XG4gICAgICAgIGlmIChjb2xWYWwgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICAgIGJsb2JFbnRyaWVzLnB1c2goXG4gICAgICAgICAgICBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgICBjb2xWYWwoKGVyciwgbmFtZSwgZW1pdHRlcikgPT4ge1xuICAgICAgICAgICAgICAgIGdldFN0cmVhbS5idWZmZXIoZW1pdHRlcikudGhlbigoYnVmZmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICByb3dzW3Jvd0luZGV4XVtjb2xLZXldID0gYnVmZmVyO1xuICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChjb2xWYWwgaW5zdGFuY2VvZiBCdWZmZXIpIHtcbiAgICAgICAgICByb3dzW3Jvd0luZGV4XVtjb2xLZXldID0gY29sVmFsLnRvU3RyaW5nKFwidXRmOFwiKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBhd2FpdCBQcm9taXNlLmFsbChibG9iRW50cmllcyk7XG5cbiAgICByZXR1cm4gcm93cztcbiAgfVxuXG4gIHZhbGlkYXRlQ29ubmVjdGlvbihkYikge1xuICAgIGNvbnN0IHsgX2lzQ2xvc2VkLCBfaXNEZXRhY2gsIF9zb2NrZXQsIF9pc09wZW5lZCB9ID0gZGIuY29ubmVjdGlvbjtcblxuICAgIGlmIChfaXNDbG9zZWQgfHwgX2lzRGV0YWNoIHx8ICFfc29ja2V0IHx8ICFfaXNPcGVuZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHBvb2xEZWZhdWx0cygpIHtcbiAgICBjb25zdCBvcHRpb25zID0geyBtaW46IDIsIG1heDogNCB9O1xuICAgIHJldHVybiBkZWZhdWx0cyhvcHRpb25zLCBzdXBlci5wb29sRGVmYXVsdHModGhpcykpO1xuICB9XG5cbiAgcGluZyhyZXNvdXJjZSwgY2FsbGJhY2spIHtcbiAgICByZXNvdXJjZS5xdWVyeShcInNlbGVjdCAxIGZyb20gUkRCJERBVEFCQVNFXCIsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIGRkbChjb21waWxlciwgcHJhZ21hLCBjb25uZWN0aW9uKSB7XG4gICAgcmV0dXJuIG5ldyBGaXJlYmlyZF9EREwodGhpcywgY29tcGlsZXIsIHByYWdtYSwgY29ubmVjdGlvbik7XG4gIH1cbn1cblxuT2JqZWN0LmFzc2lnbihDbGllbnRfRmlyZWJpcmQucHJvdG90eXBlLCB7XG4gIGRpYWxlY3Q6IFwiZmlyZWJpcmRcIixcbiAgZHJpdmVyTmFtZTogXCJub2RlLWZpcmViaXJkXCIsXG5cbiAgRmlyZWJpcmRfRm9ybWF0dGVyLFxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IENsaWVudF9GaXJlYmlyZDtcbiJdfQ==